/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocalStorageService } from 'angular-2-local-storage';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Router } from '@angular/router';
import { EventEmitter } from '@angular/core';
import { AccessTokenModel } from './access-token.model';
import { Injectable } from '@angular/core';
import { environment } from './environment';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@angular/common/http";
import * as i3 from "angular-2-local-storage";
export class AuthService {
    /**
     * @param {?} router
     * @param {?} httpClient
     * @param {?} localStorageService
     */
    constructor(router, httpClient, localStorageService) {
        this.router = router;
        this.httpClient = httpClient;
        this.localStorageService = localStorageService;
        this.searchingCode = new EventEmitter();
        this.codeNotFound = new EventEmitter();
    }
    /**
     * @return {?}
     */
    isAuthenticated() {
        /** @type {?} */
        let currentUser = this.localStorageService.get('access_token');
        if (currentUser) {
            return true;
        }
        ;
        return false;
    }
    /**
     * @param {?} email
     * @param {?} password
     * @return {?}
     */
    login(email, password) {
        /** @type {?} */
        let username = email.split("@");
        this.httpClient.post(environment.apiURL + this.codeDomain + environment.oauthURI, {
            "client_id": "columnis_manager",
            "grant_type": "password",
            "username": username[0],
            "password": password
        }).subscribe((/**
         * @param {?} response
         * @return {?}
         */
        (response) => {
            this.localStorageService.set('code', this.codeDomain);
            this.localStorageService.set('access_token', response['access_token']);
            // this.localStorageService.set('refresh_token', response['refresh_token']);
            console.log("Logged in", response);
            this.router.navigate(['/']);
            this.accessToken = this.parseAccessToken(response);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => {
            /** @type {?} */
            let message;
            // this.translateService.get('share.dialog.errorPassword').subscribe(response => {
            //     message = response;
            // });
            console.log(message);
            console.log(error.error.detail);
        }));
    }
    /**
     * @return {?}
     */
    logout() {
        // this.localStorageService.clearAll();
        this.localStorageService.remove('access_token');
        this.localStorageService.remove('code');
        this.router.navigate(['/oauth']);
    }
    /**
     * @return {?}
     */
    getAccessToken() {
        return this.localStorageService.get('access_token');
    }
    /**
     * @param {?} domain
     * @return {?}
     */
    setCode(domain) {
        this.searchingCode.emit(true);
        if (this.localStorageService.get(domain)) {
            console.log("desde ls");
            this.codeNotFound.emit(false);
            this.searchingCode.emit(false);
            this.codeDomain = this.localStorageService.get(domain);
        }
        else {
            /** @type {?} */
            let params = new HttpParams().set('domain', domain);
            this.httpClient.get(environment.apiURL + environment.codeURI, { params }).subscribe((/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                this.codeDomain = response.code;
                if (!((this.codeDomain) == '000')) {
                    this.localStorageService.set(domain, this.codeDomain);
                    this.searchingCode.emit(false); //si encuentra un codigo
                }
                else {
                    this.searchingCode.emit(false); //si no encuentra
                    this.codeNotFound.emit(true);
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                this.searchingCode.emit(false); //si no encuentra
                this.codeNotFound.emit(true);
                console.log(error);
            }));
        }
    }
    /**
     * @return {?}
     */
    getCode() {
        return this.localStorageService.get('code');
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    parseAccessToken(obj) {
        /** @type {?} */
        let accessToken = null;
        //Check access token
        if (obj && obj.access_token) {
            //parse expiration date
            /** @type {?} */
            let expiration = new Date();
            expiration.setMinutes(expiration.getMinutes() + (obj.expires_in / 60));
            //Creates the access token model
            accessToken = new AccessTokenModel(obj.access_token, obj.refresh_token, expiration);
        }
        console.log(accessToken);
        return accessToken;
    }
}
AuthService.decorators = [
    { type: Injectable, args: [{
                //duda
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AuthService.ctorParameters = () => [
    { type: Router },
    { type: HttpClient },
    { type: LocalStorageService }
];
/** @nocollapse */ AuthService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AuthService_Factory() { return new AuthService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.LocalStorageService)); }, token: AuthService, providedIn: "root" });
if (false) {
    /** @type {?} */
    AuthService.prototype.codeDomain;
    /** @type {?} */
    AuthService.prototype.searchingCode;
    /** @type {?} */
    AuthService.prototype.codeNotFound;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.accessToken;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.localStorageService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29sY3JlLWF1dGgtbGlicmFyeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctc29sY3JlLWF1dGgvIiwic291cmNlcyI6WyJsaWIvc29sY3JlLWF1dGgtbGlicmFyeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsVUFBVSxFQUFxQixVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7O0FBSzVDLE1BQU0sT0FBTyxXQUFXOzs7Ozs7SUFRcEIsWUFDWSxNQUFjLEVBQ2QsVUFBc0IsRUFDdEIsbUJBQXdDO1FBRnhDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFSN0Msa0JBQWEsR0FBMEIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUMxRCxpQkFBWSxHQUEwQixJQUFJLFlBQVksRUFBRSxDQUFDO0lBUTVELENBQUM7Ozs7SUFFRSxlQUFlOztZQUNkLFdBQVcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztRQUM5RCxJQUFJLFdBQVcsRUFBRTtZQUNiLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFBQSxDQUFDO1FBQ0YsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQzs7Ozs7O0lBRU0sS0FBSyxDQUFDLEtBQWEsRUFB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QUFZLEVBQ2hCLEdBQUcsQ0FBQyxhQUFhLEVBQ2pCLFVBQVUsQ0FDYixDQUFDO1NBQ0w7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pCLE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7OztZQXBISixVQUFVLFNBQUM7O2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBUlEsTUFBTTtZQUROLFVBQVU7WUFEVixtQkFBbUI7Ozs7O0lBYXhCLGlDQUFtQjs7SUFDbkIsb0NBQWlFOztJQUNqRSxtQ0FBZ0U7Ozs7O0lBRWhFLGtDQUFzQzs7Ozs7SUFHbEMsNkJBQXNCOzs7OztJQUN0QixpQ0FBOEI7Ozs7O0lBQzlCLDBDQUFnRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICdhbmd1bGFyLTItbG9jYWwtc3RvcmFnZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjY2Vzc1Rva2VuTW9kZWwgfSBmcm9tICcuL2FjY2Vzcy10b2tlbi5tb2RlbCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBlbnZpcm9ubWVudCB9IGZyb20gJy4vZW52aXJvbm1lbnQnO1xuXG5ASW5qZWN0YWJsZSh7IC8vZHVkYVxuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2Uge1xuXG4gICAgY29kZURvbWFpbjogc3RyaW5nO1xuICAgIHB1YmxpYyBzZWFyY2hpbmdDb2RlOiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgcHVibGljIGNvZGVOb3RGb3VuZDogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgcHJpdmF0ZSBhY2Nlc3NUb2tlbjogQWNjZXNzVG9rZW5Nb2RlbDtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgICAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgICAgIHByaXZhdGUgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZVxuICAgICkgeyB9XG5cbiAgICBwdWJsaWMgaXNBdXRoZW50aWNhdGVkKCkge1xuICAgICAgICBsZXQgY3VycmVudFVzZXIgPSB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdhY2Nlc3NfdG9rZW4nKTtcbiAgICAgICAgaWYgKGN1cnJlbnRVc2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2dpbihlbWFpbDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKSB7XG4gICAgICAgIGxldCB1c2VybmFtZSA9IGVtYWlsLnNwbGl0KFwiQFwiKTtcblxuICAgICAgICB0aGlzLmh0dHBDbGllbnQucG9zdChlbnZpcm9ubWVudC5hcGlVUkwgKyB0aGlzLmNvZGVEb21haW4gKyBlbnZpcm9ubWVudC5vYXV0aFVSSSwge1xuICAgICAgICAgICAgXCJjbGllbnRfaWRcIjogXCJjb2x1bW5pc19tYW5hZ2VyXCIsXG4gICAgICAgICAgICBcImdyYW50X3R5cGVcIjogXCJwYXNzd29yZFwiLFxuICAgICAgICAgICAgXCJ1c2VybmFtZVwiOiB1c2VybmFtZVswXSxcbiAgICAgICAgICAgIFwicGFzc3dvcmRcIjogcGFzc3dvcmRcbiAgICAgICAgfSkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0KCdjb2RlJywgdGhpcy5jb2RlRG9tYWluKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0KCdhY2Nlc3NfdG9rZW4nLCByZXNwb25zZVsnYWNjZXNzX3Rva2VuJ10pO1xuXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnNldCgncmVmcmVzaF90b2tlbicsIHJlc3BvbnNlWydyZWZyZXNoX3Rva2VuJ10pO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTG9nZ2VkIGluXCIsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy8nXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5hY2Nlc3NUb2tlbiA9IHRoaXMucGFyc2VBY2Nlc3NUb2tlbihyZXNwb25zZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBtZXNzYWdlOiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmdldCgnc2hhcmUuZGlhbG9nLmVycm9yUGFzc3dvcmQnKS5zdWJzY3JpYmUocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIC8vICAgICBtZXNzYWdlID0gcmVzcG9uc2U7XG4gICAgICAgICAgICAgICAgLy8gfSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IuZXJyb3IuZGV0YWlsKTtcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvZ291dCgpIHtcbiAgICAgICAgLy8gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmNsZWFyQWxsKCk7XG4gICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5yZW1vdmUoJ2FjY2Vzc190b2tlbicpO1xuICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UucmVtb3ZlKCdjb2RlJyk7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnL29hdXRoJ10pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRBY2Nlc3NUb2tlbigpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldCgnYWNjZXNzX3Rva2VuJyk7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgc2V0Q29kZShkb21haW46IHN0cmluZykge1xuICAgICAgICB0aGlzLnNlYXJjaGluZ0NvZGUuZW1pdCh0cnVlKTtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoZG9tYWluKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJkZXNkZSBsc1wiKTtcbiAgICAgICAgICAgIHRoaXMuY29kZU5vdEZvdW5kLmVtaXQoZmFsc2UpO1xuICAgICAgICAgICAgdGhpcy5zZWFyY2hpbmdDb2RlLmVtaXQoZmFsc2UpO1xuICAgICAgICAgICAgdGhpcy5jb2RlRG9tYWluID0gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldChkb21haW4pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IHBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCkuc2V0KCdkb21haW4nLCBkb21haW4pO1xuICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50LmdldChlbnZpcm9ubWVudC5hcGlVUkwgKyBlbnZpcm9ubWVudC5jb2RlVVJJLCB7IHBhcmFtcyB9KS5zdWJzY3JpYmUoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvZGVEb21haW4gPSByZXNwb25zZS5jb2RlO1xuICAgICAgICAgICAgICAgIGlmICghKCh0aGlzLmNvZGVEb21haW4pID09ICcwMDAnKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0KGRvbWFpbiwgdGhpcy5jb2RlRG9tYWluKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hpbmdDb2RlLmVtaXQoZmFsc2UpOyAvL3NpIGVuY3VlbnRyYSB1biBjb2RpZ29cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaGluZ0NvZGUuZW1pdChmYWxzZSk7IC8vc2kgbm8gZW5jdWVudHJhXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29kZU5vdEZvdW5kLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoaW5nQ29kZS5lbWl0KGZhbHNlKTsgLy9zaSBubyBlbmN1ZW50cmFcbiAgICAgICAgICAgICAgICB0aGlzLmNvZGVOb3RGb3VuZC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldENvZGUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2NvZGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlQWNjZXNzVG9rZW4ob2JqOiBhbnkpOiBBY2Nlc3NUb2tlbk1vZGVsIHtcbiAgICAgICAgbGV0IGFjY2Vzc1Rva2VuOiBBY2Nlc3NUb2tlbk1vZGVsID0gbnVsbDtcblxuICAgICAgICAvL0NoZWNrIGFjY2VzcyB0b2tlblxuICAgICAgICBpZiAob2JqICYmIG9iai5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgICAgIC8vcGFyc2UgZXhwaXJhdGlvbiBkYXRlXG4gICAgICAgICAgICBsZXQgZXhwaXJhdGlvbiA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBleHBpcmF0aW9uLnNldE1pbnV0ZXMoZXhwaXJhdGlvbi5nZXRNaW51dGVzKCkgKyAob2JqLmV4cGlyZXNfaW4gLyA2MCkpO1xuXG4gICAgICAgICAgICAvL0NyZWF0ZXMgdGhlIGFjY2VzcyB0b2tlbiBtb2RlbFxuICAgICAgICAgICAgYWNjZXNzVG9rZW4gPSBuZXcgQWNjZXNzVG9rZW5Nb2RlbChcbiAgICAgICAgICAgICAgICBvYmouYWNjZXNzX3Rva2VuLFxuICAgICAgICAgICAgICAgIG9iai5yZWZyZXNoX3Rva2VuLFxuICAgICAgICAgICAgICAgIGV4cGlyYXRpb25cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coYWNjZXNzVG9rZW4pO1xuICAgICAgICByZXR1cm4gYWNjZXNzVG9rZW47XG4gICAgfVxuXG59Il19