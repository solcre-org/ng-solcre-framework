/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocalStorageService } from 'angular-2-local-storage';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Router } from '@angular/router';
import { EventEmitter } from '@angular/core';
import { AccessTokenModel } from './access-token.model';
import { Injectable } from '@angular/core';
import { environment } from './environment';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@angular/common/http";
import * as i3 from "angular-2-local-storage";
var AuthService = /** @class */ (function () {
    function AuthService(router, httpClient, localStorageService) {
        this.router = router;
        this.httpClient = httpClient;
        this.localStorageService = localStorageService;
        this.searchingCode = new EventEmitter();
        this.codeNotFound = new EventEmitter();
    }
    /**
     * @return {?}
     */
    AuthService.prototype.isAuthenticated = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var currentUser = this.localStorageService.get('access_token');
        if (currentUser) {
            return true;
        }
        ;
        return false;
    };
    /**
     * @param {?} email
     * @param {?} password
     * @return {?}
     */
    AuthService.prototype.login = /**
     * @param {?} email
     * @param {?} password
     * @return {?}
     */
    function (email, password) {
        var _this = this;
        /** @type {?} */
        var username = email.split("@");
        this.httpClient.post(environment.apiURL + this.codeDomain + environment.oauthURI, {
            "client_id": "columnis_manager",
            "grant_type": "password",
            "username": username[0],
            "password": password
        }).subscribe((/**
         * @param {?} response
         * @return {?}
         */
        function (response) {
            _this.localStorageService.set('code', _this.codeDomain);
            _this.localStorageService.set('access_token', response['access_token']);
            // this.localStorageService.set('refresh_token', response['refresh_token']);
            console.log("Logged in", response);
            _this.router.navigate(['/']);
            _this.accessToken = _this.parseAccessToken(response);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var message;
            // this.translateService.get('share.dialog.errorPassword').subscribe(response => {
            //     message = response;
            // });
            console.log(message);
            console.log(error.error.detail);
        }));
    };
    /**
     * @return {?}
     */
    AuthService.prototype.logout = /**
     * @return {?}
     */
    function () {
        // this.localStorageService.clearAll();
        this.localStorageService.remove('access_token');
        this.localStorageService.remove('code');
        this.router.navigate(['/oauth']);
    };
    /**
     * @return {?}
     */
    AuthService.prototype.getAccessToken = /**
     * @return {?}
     */
    function () {
        return this.localStorageService.get('access_token');
    };
    /**
     * @param {?} domain
     * @return {?}
     */
    AuthService.prototype.setCode = /**
     * @param {?} domain
     * @return {?}
     */
    function (domain) {
        var _this = this;
        this.searchingCode.emit(true);
        if (this.localStorageService.get(domain)) {
            console.log("desde ls");
            this.codeNotFound.emit(false);
            this.searchingCode.emit(false);
            this.codeDomain = this.localStorageService.get(domain);
        }
        else {
            /** @type {?} */
            var params = new HttpParams().set('domain', domain);
            this.httpClient.get(environment.apiURL + environment.codeURI, { params: params }).subscribe((/**
             * @param {?} response
             * @return {?}
             */
            function (response) {
                _this.codeDomain = response.code;
                if (!((_this.codeDomain) == '000')) {
                    _this.localStorageService.set(domain, _this.codeDomain);
                    _this.searchingCode.emit(false); //si encuentra un codigo
                }
                else {
                    _this.searchingCode.emit(false); //si no encuentra
                    _this.codeNotFound.emit(true);
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                _this.searchingCode.emit(false); //si no encuentra
                _this.codeNotFound.emit(true);
                console.log(error);
            }));
        }
    };
    /**
     * @return {?}
     */
    AuthService.prototype.getCode = /**
     * @return {?}
     */
    function () {
        return this.localStorageService.get('code');
    };
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    AuthService.prototype.parseAccessToken = /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    function (obj) {
        /** @type {?} */
        var accessToken = null;
        //Check access token
        if (obj && obj.access_token) {
            //parse expiration date
            /** @type {?} */
            var expiration = new Date();
            expiration.setMinutes(expiration.getMinutes() + (obj.expires_in / 60));
            //Creates the access token model
            accessToken = new AccessTokenModel(obj.access_token, obj.refresh_token, expiration);
        }
        console.log(accessToken);
        return accessToken;
    };
    AuthService.decorators = [
        { type: Injectable, args: [{
                    //duda
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    AuthService.ctorParameters = function () { return [
        { type: Router },
        { type: HttpClient },
        { type: LocalStorageService }
    ]; };
    /** @nocollapse */ AuthService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AuthService_Factory() { return new AuthService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.HttpClient), i0.ɵɵinject(i3.LocalStorageService)); }, token: AuthService, providedIn: "root" });
    return AuthService;
}());
export { AuthService };
if (false) {
    /** @type {?} */
    AuthService.prototype.codeDomain;
    /** @type {?} */
    AuthService.prototype.searchingCode;
    /** @type {?} */
    AuthService.prototype.codeNotFound;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.accessToken;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.localStorageService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29sY3JlLWF1dGgtbGlicmFyeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctc29sY3JlLWF1dGgvIiwic291cmNlcyI6WyJsaWIvc29sY3JlLWF1dGgtbGlicmFyeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsVUFBVSxFQUFxQixVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7O0FBRTVDO0lBV0kscUJBQ1ksTUFBYyxFQUNkLFVBQXNCLEVBQ3RCLG1CQUF3QztRQUZ4QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBUjdDLGtCQUFhLEdBQTBCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUQsaUJBQVksR0FBMEIsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQVE1RCxDQUFDOzs7O0lBRUUscUNBQWU7OztJQUF0Qjs7WUFDUSxXQUFXLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7UUFDOUQsSUFBSSxXQUFXLEVBQUU7WUFDYixPQUFPLElBQUksQ0FBQztTQUNmO1FBQUEsQ0FBQztRQUNGLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7OztJQUVNLDJCQUFLOzs7OztJQUFaLFVBQWEsS0FBYSxFQUFF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R0FBRyxJQUFJLGdCQUFnQixDQUM5QixHQUFHLENBQUMsWUFBWSxFQUNoQixHQUFHLENBQUMsYUFBYSxFQUNqQixVQUFVLENBQ2IsQ0FBQztTQUNMO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6QixPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDOztnQkFwSEosVUFBVSxTQUFDOztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0JBUlEsTUFBTTtnQkFETixVQUFVO2dCQURWLG1CQUFtQjs7O3NCQUE1QjtDQThIQyxBQXRIRCxJQXNIQztTQW5IWSxXQUFXOzs7SUFFcEIsaUNBQW1COztJQUNuQixvQ0FBaUU7O0lBQ2pFLG1DQUFnRTs7Ozs7SUFFaEUsa0NBQXNDOzs7OztJQUdsQyw2QkFBc0I7Ozs7O0lBQ3RCLGlDQUE4Qjs7Ozs7SUFDOUIsMENBQWdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJ2FuZ3VsYXItMi1sb2NhbC1zdG9yYWdlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWNjZXNzVG9rZW5Nb2RlbCB9IGZyb20gJy4vYWNjZXNzLXRva2VuLm1vZGVsJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGVudmlyb25tZW50IH0gZnJvbSAnLi9lbnZpcm9ubWVudCc7XG5cbkBJbmplY3RhYmxlKHsgLy9kdWRhXG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSB7XG5cbiAgICBjb2RlRG9tYWluOiBzdHJpbmc7XG4gICAgcHVibGljIHNlYXJjaGluZ0NvZGU6IEV2ZW50RW1pdHRlcjxib29sZWFuPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICBwdWJsaWMgY29kZU5vdEZvdW5kOiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICBwcml2YXRlIGFjY2Vzc1Rva2VuOiBBY2Nlc3NUb2tlbk1vZGVsO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICAgICAgcHJpdmF0ZSBsb2NhbFN0b3JhZ2VTZXJ2aWNlOiBMb2NhbFN0b3JhZ2VTZXJ2aWNlXG4gICAgKSB7IH1cblxuICAgIHB1YmxpYyBpc0F1dGhlbnRpY2F0ZWQoKSB7XG4gICAgICAgIGxldCBjdXJyZW50VXNlciA9IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2FjY2Vzc190b2tlbicpO1xuICAgICAgICBpZiAoY3VycmVudFVzZXIpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcHVibGljIGxvZ2luKGVtYWlsOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IHVzZXJuYW1lID0gZW1haWwuc3BsaXQoXCJAXCIpO1xuXG4gICAgICAgIHRoaXMuaHR0cENsaWVudC5wb3N0KGVudmlyb25tZW50LmFwaVVSTCArIHRoaXMuY29kZURvbWFpbiArIGVudmlyb25tZW50Lm9hdXRoVVJJLCB7XG4gICAgICAgICAgICBcImNsaWVudF9pZFwiOiBcImNvbHVtbmlzX21hbmFnZXJcIixcbiAgICAgICAgICAgIFwiZ3JhbnRfdHlwZVwiOiBcInBhc3N3b3JkXCIsXG4gICAgICAgICAgICBcInVzZXJuYW1lXCI6IHVzZXJuYW1lWzBdLFxuICAgICAgICAgICAgXCJwYXNzd29yZFwiOiBwYXNzd29yZFxuICAgICAgICB9KS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXQoJ2NvZGUnLCB0aGlzLmNvZGVEb21haW4pO1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXQoJ2FjY2Vzc190b2tlbicsIHJlc3BvbnNlWydhY2Nlc3NfdG9rZW4nXSk7XG5cbiAgICAgICAgICAgICAgICAvLyB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0KCdyZWZyZXNoX3Rva2VuJywgcmVzcG9uc2VbJ3JlZnJlc2hfdG9rZW4nXSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJMb2dnZWQgaW5cIiwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLyddKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFjY2Vzc1Rva2VuID0gdGhpcy5wYXJzZUFjY2Vzc1Rva2VuKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2U6IHN0cmluZztcbiAgICAgICAgICAgICAgICAvLyB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuZ2V0KCdzaGFyZS5kaWFsb2cuZXJyb3JQYXNzd29yZCcpLnN1YnNjcmliZShyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gICAgIG1lc3NhZ2UgPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICAvLyB9KTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvci5lcnJvci5kZXRhaWwpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9nb3V0KCkge1xuICAgICAgICAvLyB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuY2xlYXJBbGwoKTtcbiAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnJlbW92ZSgnYWNjZXNzX3Rva2VuJyk7XG4gICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5yZW1vdmUoJ2NvZGUnKTtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvb2F1dGgnXSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEFjY2Vzc1Rva2VuKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdhY2Nlc3NfdG9rZW4nKTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBzZXRDb2RlKGRvbWFpbjogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2VhcmNoaW5nQ29kZS5lbWl0KHRydWUpO1xuICAgICAgICBpZiAodGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldChkb21haW4pKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImRlc2RlIGxzXCIpO1xuICAgICAgICAgICAgdGhpcy5jb2RlTm90Rm91bmQuZW1pdChmYWxzZSk7XG4gICAgICAgICAgICB0aGlzLnNlYXJjaGluZ0NvZGUuZW1pdChmYWxzZSk7XG4gICAgICAgICAgICB0aGlzLmNvZGVEb21haW4gPSB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KGRvbWFpbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKS5zZXQoJ2RvbWFpbicsIGRvbWFpbik7XG4gICAgICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KGVudmlyb25tZW50LmFwaVVSTCArIGVudmlyb25tZW50LmNvZGVVUkksIHsgcGFyYW1zIH0pLnN1YnNjcmliZSgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29kZURvbWFpbiA9IHJlc3BvbnNlLmNvZGU7XG4gICAgICAgICAgICAgICAgaWYgKCEoKHRoaXMuY29kZURvbWFpbikgPT0gJzAwMCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXQoZG9tYWluLCB0aGlzLmNvZGVEb21haW4pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaGluZ0NvZGUuZW1pdChmYWxzZSk7IC8vc2kgZW5jdWVudHJhIHVuIGNvZGlnb1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoaW5nQ29kZS5lbWl0KGZhbHNlKTsgLy9zaSBubyBlbmN1ZW50cmFcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2RlTm90Rm91bmQuZW1pdCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hpbmdDb2RlLmVtaXQoZmFsc2UpOyAvL3NpIG5vIGVuY3VlbnRyYVxuICAgICAgICAgICAgICAgIHRoaXMuY29kZU5vdEZvdW5kLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Q29kZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldCgnY29kZScpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VBY2Nlc3NUb2tlbihvYmo6IGFueSk6IEFjY2Vzc1Rva2VuTW9kZWwge1xuICAgICAgICBsZXQgYWNjZXNzVG9rZW46IEFjY2Vzc1Rva2VuTW9kZWwgPSBudWxsO1xuXG4gICAgICAgIC8vQ2hlY2sgYWNjZXNzIHRva2VuXG4gICAgICAgIGlmIChvYmogJiYgb2JqLmFjY2Vzc190b2tlbikge1xuICAgICAgICAgICAgLy9wYXJzZSBleHBpcmF0aW9uIGRhdGVcbiAgICAgICAgICAgIGxldCBleHBpcmF0aW9uID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGV4cGlyYXRpb24uc2V0TWludXRlcyhleHBpcmF0aW9uLmdldE1pbnV0ZXMoKSArIChvYmouZXhwaXJlc19pbiAvIDYwKSk7XG5cbiAgICAgICAgICAgIC8vQ3JlYXRlcyB0aGUgYWNjZXNzIHRva2VuIG1vZGVsXG4gICAgICAgICAgICBhY2Nlc3NUb2tlbiA9IG5ldyBBY2Nlc3NUb2tlbk1vZGVsKFxuICAgICAgICAgICAgICAgIG9iai5hY2Nlc3NfdG9rZW4sXG4gICAgICAgICAgICAgICAgb2JqLnJlZnJlc2hfdG9rZW4sXG4gICAgICAgICAgICAgICAgZXhwaXJhdGlvblxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhhY2Nlc3NUb2tlbik7XG4gICAgICAgIHJldHVybiBhY2Nlc3NUb2tlbjtcbiAgICB9XG5cbn0iXX0=